IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'PRC_GEN_TITULO')
BEGIN
    DROP PROCEDURE PRC_GEN_TITULO;
END
GO

CREATE PROCEDURE PRC_GEN_TITULO
    @idLiquidacion INT
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @anio INT, @mes INT;
    DECLARE @fechaInicioLiquidacion DATE;

    -- Obtener a√±o y mes desde la tabla Liquidacion
    SELECT @anio = L.ANIO, @mes = L.MES
    FROM LIQUIDACION L
    WHERE L.ID = @idLiquidacion;

    -- Calcular fecha
    SET @fechaInicioLiquidacion = DATEFROMPARTS(@anio, @mes, 1);

    -- Insertar en TabuladoConcepto
    INSERT INTO TABULADO_CONCEPTO (ID_TABULADO, ID_CONCEPTO, MONTO, SENTIDO)
    SELECT T.ID, 
		(SELECT ID 
		FROM CONCEPTO 
		WHERE CONCEPTO.CODIGO='D0002') ID_CONCEPTO, 
	CASE 
		WHEN TI.TIPO = 'INGENIERO' THEN J.MONTO*0.6
		WHEN TI.TIPO = 'CONTADOR' THEN J.MONTO*0.5
		WHEN TI.TIPO = 'ABOGADO' THEN J.MONTO*0.4
		WHEN TI.TIPO = 'LIC_ADMINISTRACION' THEN J.MONTO*0.3
		WHEN TI.TIPO = 'TEC_HIGIENE' THEN J.MONTO*0.2
		WHEN TI.TIPO = 'TEC_INFO' THEN J.MONTO*0.1
	END,
	'D'
    FROM PERSONA P
    JOIN NOU NOU ON NOU.ID_PERSONA = P.ID
    JOIN EVENTO_NOU EN ON EN.NOU_ID = NOU.ID
    JOIN EVENTO E ON E.ID = EN.EVENTO_ID
    JOIN TABULADO T ON T.ID_NOU = NOU.ID
	JOIN JERARQUIA J ON J.ID=P.ID_JERARQUIA
	JOIN TITULO TI ON TI.ID=P.ID_TITULO
    WHERE EN.FECHA_INICIO <= @fechaInicioLiquidacion
      AND EN.FECHA_FIN > @fechaInicioLiquidacion
      AND T.ID_LIQUIDACION = @idLiquidacion
      AND E.IDENTIFICADOR = 'TITULO';
END;
